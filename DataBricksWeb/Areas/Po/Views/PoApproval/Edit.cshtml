@model DataBricksWeb.Areas.Po.Data.PoModel
@{
    ViewBag.Title = "Edit";
}



<style>
    #tblModule {
        font-family: Arial, Helvetica, sans-serif;
        border-collapse: collapse;
        width: 100%;
    }

        #tblModule td, #customers th {
            border: 1px solid #ddd;
            padding: 8px;
        }

        #tblModule tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        #tblModule tr:hover {
            background-color: #ddd;
        }

        #tblModule th {
            padding-top: 12px;
            padding-bottom: 12px;
            text-align: left;
            background-color: #3c8dbc;
            color: white;
        }

    #tblLicensing {
        font-family: Arial, Helvetica, sans-serif;
        border-collapse: collapse;
        width: 100%;
    }

        #tblLicensing td, #customers th {
            border: 1px solid #ddd;
            padding: 8px;
        }

        #tblLicensing tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        #tblLicensing tr:hover {
            background-color: #ddd;
        }

        #tblLicensing th {
            padding-top: 12px;
            padding-bottom: 12px;
            text-align: left;
            background-color: #3c8dbc;
            color: white;
        }
    
</style>


<section class="content-header">
    <h1>
        Po
    </h1>
    <ol class="breadcrumb">
        <li><a href="/dashboard/landingpage"><i class="fa fa-dashboard"></i> Home</a></li>
        <li><a href="/poapprovals/list">Po List</a></li>
        <li class="active">Po</li>
    </ol>
</section>
<div id="newloader">
    <section class="content">
        <br />
        <br />
        <br />
        <br />
        <br />
        <div class="row">
            <div class="col-md-4">
            </div>
            <div class="col-md-4">
                <img style="width: 30%;margin-left: 100px;margin-top: 55px;" src="~/NewAdmin/dist/img/loading-waiting.gif" class="img-circle" alt="User Image">
            </div>
            <div class="col-md-4">
            </div>
        </div>
    </section>
</div>
<!-- Main content -->
<div id="tablehide" style="display:none;">
    <section class="content">

        <!-- SELECT2 EXAMPLE -->
        <div class="box box-default">

            <!-- /.box-header -->
            <form method="post" action="@Url.Action("Edit","PoApproval",new { area = "Po"})" enctype="multipart/form-data" id="frmPo">
                <div class="box-body">
                    <div class="row">
                        <input type="hidden" id="hdnStatus" name="Po.Status" />
                        <input type="hidden" id="" name="Po.Id" value="@Model.Po.Id" />
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Customer</label>
                                <div>
                                    <span>@Model.Po.CustomerName</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Date<span style="color:red;">*</span></label>
                                <div>
                                    <span>@Model.Po.PODate</span>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group">
                                <label>POC Id</label>
                                <div>
                                    <span>@Model.Po.PocId</span>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Partner</label>
                                <div>
                                    <span>@Model.Po.PartnerName</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Product Name<span style="color:red;">*</span></label>
                                <div>
                                    <span>@Model.Po.ProductName</span>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Qualified Domain Name<span style="color:red;">*</span></label>
                                <div>
                                    <span>@Model.Po.QualifiedDomainName</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Public IP<span style="color:red;">*</span></label>
                                <div>
                                    <span>@Model.Po.PublicIp</span>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Description</label>
                                <div>
                                    <span>@Model.Po.PODescription</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Uploaded POs</label>
                                <div>
                                    @if (Model.Po.PoAttachments != null && Model.Po.PoAttachments.Count > 0)
                                    {
                                        foreach (var fl in Model.Po.PoAttachments)
                                        {
                                            <a href="@Url.Action("DownloadFile","ManageCommon",new { area = "Common"})?id=@fl.Id&category=@FileCategory.PO" target="_blank">@fl.FileName</a><br />
                                        }
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                        </div>

                    </div>
                 
                    <br />
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <h4 style="color:black;font-weight: bold;">Technical Contact Person 1</h4>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Name<span style="color:red;">*</span></label>
                                <div>
                                    <span>@Model.Po.TechContPersonNameOne</span>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Email<span style="color:red;">*</span></label>
                                <div>
                                    <span>@Model.Po.TechContPersonEmailOne</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Email<span style="color:red;">*</span></label>
                                <div>
                                    <span>@Model.Po.TechContPersonPhoneOne</span>
                                </div>
                            </div>
                        </div>
                    </div>




                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <h4 style="color:black;font-weight: bold;">Technical Contact Person 2</h4>
                            </div>
                        </div>
                    </div>
                    <div class="row">

                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Name<span style="color:red;">*</span></label>
                                <div>
                                    <span>@Model.Po.TechContPersonNameTwo</span>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Name<span style="color:red;">*</span></label>
                                <div>
                                    <span>@Model.Po.TechContPersonEmailTwo</span>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Name<span style="color:red;">*</span></label>
                                <div>
                                    <span>@Model.Po.TechContPersonPhoneTwo</span>
                                </div>
                            </div>
                        </div>
                    </div>



                    <br />
                    <div class="row">
                        <div class="col-md-12">

                            <table class="table table-bordered table-responsive" id="tblModule">
                                <thead>
                                    <tr>
                                        <th>Module</th>
                                        <th>Count</th>
                                        <th>Amount</th>
                                        <th>Total</th>
                                        <th>From Date</th>
                                        <th>To Date</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>

                                    @if (Model.PoModules != null && Model.PoModules.Count > 0)
                                    {
                                        int i = 0;
                                        foreach (var module in Model.PoModules)
                                        {
                                            <tr>
                                                <td>
                                                    <select class="slModule form-control validate" data-errmsg="please select module name" id="slModule_@i" name="PoModules[@i].ModuleId">
                                                        <option value="0">--Select--</option>
                                                        @if (DataCache.Modules.Where(x => x.ProductId == Model.Po.ProductId) != null && DataCache.Modules.Where(x => x.ProductId == Model.Po.ProductId).Count() > 0)
                                                        {
                                                            foreach (var item in DataCache.Modules.Where(x => x.ProductId == Model.Po.ProductId).ToList())
                                                            {
                                                                if (item.Id == module.ModuleId)
                                                                {
                                                                    <option value="@item.Id" selected>@item.ModuleName</option>
                                                                }
                                                                else
                                                                {
                                                                    <option value="@item.Id">@item.ModuleName</option>
                                                                }
                                                            }
                                                        }
                                                    </select>
                                                </td>
                                                <td>
                                                    <input type="number" class="form-control validate txtLineModuleCount" value="@module.ModuleCount" data-errmsg="please enter module count" name="PoModules[@i].ModuleCount" />
                                                    <input type="hidden" class="hdnIsActive" value="true" name="PoModules[@i].IsActive" />
                                                    <input type="hidden" name="PoModules[@i].Id" value="@module.Id" />
                                                </td>
                                                <td>
                                                    <input type="number" class="form-control validate txtLineModuleAmount" data-errmsg="please enter module amount" name="PoModules[@i].ModuleAmount" value="@module.ModuleAmount" />
                                                </td>
                                                <td>
                                                    <input type="number" class="form-control validate txtLineFinalModuleCount" data-errmsg="please enter total amount" readonly name="" value="@(module.ModuleCount * Convert.ToInt32(module.ModuleAmount))" />
                                                </td>
                                                <td>
                                                    <input type="text" class="form-control validate txtFromDate" data-errmsg="please enter module from date" name="PoModules[@i].FromDate" value="@module.FromDate.ToAppFormat()" />
                                                </td>
                                                <td>
                                                    <input type="text" class="form-control validate txtToDate" data-errmsg="please enter module to date" name="PoModules[@i].ToDate" value="@module.ToDate.ToAppFormat()" />
                                                </td>
                                                <td style="text-align:center">
                                                    <label class="label btnDeleteModule" style="color:red;">X</label>
                                                </td>
                                            </tr>
                                            i++;
                                        }
                                    }

                                </tbody>
                            </table>
                            <input type="button" value="+ Add Module" id="btnAddModule" />
                        </div>
                    </div>
                </div>

                <br />
               
                <div class="box-body">
               
                    <h4 style="color: black;font-weight: bold;">Licensing Details</h4>
                    <div class="row">
                        <div class="col-md-12">

                            <table class="table table-bordered table-responsive" id="tblLicensing">
                                <thead>
                                    <tr>
                                        <th>Module</th>
                                        <th>Count</th>
                                        <th>Amount</th>
                                        <th>From Date</th>
                                        <th>To Date</th>
                                    </tr>
                                </thead>
                                <tbody>

                                    @if (Model.Licensings != null && Model.Licensings.Count > 0)
                                    {
                                        int i = 0;
                                        foreach (var module in Model.Licensings)
                                        {
                                            <tr>
                                                <td>
                                                    <span>@module.ModuleName</span>
                                                </td>
                                                <td>
                                                    <span>@module.ModuleCount</span>
                                                </td>
                                                <td>
                                                    <span>@module.ModuleAmount</span>
                                                </td>
                                                <td>
                                                    <input type="hidden" value="@module.Id" name="Licensings[@i].Id" />
                                                    <input type="text" class="form-control txtFromDate validatelicense" data-errmsg="please enter module from date" name="Licensings[@i].FromDate" value="@module.FromDate.ToAppFormat()" />
                                                </td>
                                                <td>
                                                    <input type="text" class="form-control txtToDate validatelicense" data-errmsg="please enter module to date" name="Licensings[@i].ToDate" value="@module.ToDate.ToAppFormat()" />
                                                </td>
                                            </tr>
                                            i++;
                                        }
                                    }

                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                    <div class="box-footer">
                        <div class="col-lg-12 p-t-20 text-center">
                            <button type="button" style="background-color: #135434; border-color: #135434;margin-left: 10px;" class="btn btn-primary float-center" id="btnApprove">Approve</button>
                            <button type="button" style="background-color: #dc3545; border-color: #dc3545;margin-left: 10px;" class="btn btn-primary float-center" id="btnReject">Reject</button>
                            <button type="button" onclick="pageloade();" style="background-color: #dc3545; border-color: #dc3545;margin-left: 10px;" class="btn btn-primary float-center">Cancel</button>
                        </div>
                    </div>
            </form>
        </div>


    </section>

</div>









<script src="~/Scripts/jquery-3.4.1.min.js"></script>
<script src="~/Scripts/CustomScript.js"></script>
<script src="~/Scripts/bootstrap.js"></script>
<script>

    function pageloade() {
        window.location = "/poapproval/list";
    }

    $(document).on("focusin", ".txtFromDate,.txtToDate", function () {
        $(this).datepicker({ autoclose: true, dateFormat: "dd-mm-yy" });
    });

    $("#btnAddModule").click(function () {
        fnAddModule();
    });

    function fnAddModule() {
        var trlength = $("#tblModule tbody tr").length;
        $("#tblModule").append('<tr>' +
            '<td>' +
            '<select class="slModule validate form-control" id="slModule_' + trlength + '" data-errmsg="please select module name"  name="PoModules[' + trlength + '].ModuleId">' +
            '    <option value="0">--Select--</option>' +
            '</select>' +
            '        </td>' +
            '<td>' +
            '    <input type="number" class="form-control txtLineModuleCount validate" data-errmsg="please enter module count"  name="PoModules[' + trlength + '].ModuleCount" />' +
            '<input type="hidden" class="hdnIsActive" value="true" name="PoModules[' + trlength + '].IsActive" />' +
            '</td>' +
            '<td>' +
            '           <input type="number" class="form-control txtLineModuleAmount validate" data-errmsg="please enter module amount"  name="PoModules[' + trlength + '].ModuleAmount" value="" />' +
            '        </td>' +
            '        <td>' +
            '            <input type="number" class="form-control txtLineFinalModuleCount validate" data-errmsg="please enter total amount" readonly name="" value="" />' +
            '        </td>' +
            '<td><input type="text" class="form-control txtFromDate" data-errmsg="please enter module from date" name="PoModules[' + trlength + '].FromDate" /></td>' +
            '<td><input type="text" class="form-control txtToDate" data-errmsg="please enter module to date" name="PoModules[' + trlength + '].ToDate" /></td>' +
            '<td style="text-align:center">' +
            '    <label class="label btnDeleteModule" style="color:red;">X</label>' +
            '</td>' +
            '    </tr>');
        fnSelectModule("slModule_" + trlength, null);
    };

     function fnSelectModule(ddlid,moduleid) {
        $.getJSON("@Url.Action("GetModulesbasedonProduct", "ManageCommon",new { area = "Common"})?productid=" + "@Model.Po.ProductId", function (data) {
            var option = '<option value="0">--Select--</option>';
            $.each(data, function (index, item) {
                if (moduleid != null && moduleid > 0 && item.Id == moduleid) {
                    option += '<option value="' + item.Id + '" selected>' + item.ModuleName + '</option>';
                }
                else {
                    option += '<option value="' + item.Id + '">' + item.ModuleName + '</option>';
                }
            });
            $("#" + ddlid).html(option);
        });
    };

    $(document).on("click", ".btnDeleteModule", function () {
        $(this).closest("tr").find(".hdnIsActive").val(false);
        $(this).closest("tr").hide();
    });

    $(document).on("change", ".txtLineModuleAmount", function () {
        var moduleamount = $(this).val();
        var modulecount = $(this).closest("tr").find(".txtLineModuleCount").val();
        var finalamount = fnCalculateTotalModuleAmount(moduleamount, modulecount);
        $(this).closest("tr").find(".txtLineFinalModuleCount").val(finalamount);
    });

    $(document).on("change", ".txtLineModuleCount", function () {
        var modulecount = $(this).val();
        var moduleamount = $(this).closest("tr").find(".txtLineModuleAmount").val();
        var finalamount = fnCalculateTotalModuleAmount(moduleamount, modulecount);
        $(this).closest("tr").find(".txtLineFinalModuleCount").val(finalamount);
    });


    function fnCalculateTotalModuleAmount(modulecount, moduleamount) {
        return parseInt(modulecount * moduleamount);
    };

    $("#btnApprove").click(function () {
        var isvalid = true; var errmsg;
        debugger;
        $(".validate").each(function () {
            debugger;
            if ($(this).closest("tr").find(".hdnIsActive").val() == "true") {
                if ($(this).val() == 0 || $(this).val() == "") {
                    errmsg = $(this).attr("data-errmsg");
                    isvalid = false;
                    return false;
                }
            }
        });
        if (isvalid == false) {
            Warning(errmsg);
            return false;
        }


        var isvalidlicense = true; var errmsglicense;
        $(".validatelicense").each(function () {
            if ($(this).val() == 0 || $(this).val() == "") {
                errmsg = $(this).attr("data-errmsg");
                isvalid = false;
                return false;
            }
        });
        if (isvalidlicense == false) {
            Warning(errmsglicense);
            return false;
        }

        Confirmation("Are you sure, you want to approve?");
        $("#btnConfirm").unbind().click(function () {
            $("#hdnStatus").val('@Statusses.Approved');
            $("#frmPo").submit();
        });
    });

    $("#btnReject").click(function () {
        Confirmation("Are you sure, you want to reject?");
        $("#btnConfirm").unbind().click(function () {
            $("#hdnStatus").val('@Statusses.Rejected');
            $("#frmPo").submit();
        });
    });

</script>

<script>
    window.setInterval('refresh()', 1000);
    function refresh() {
        document.getElementById("newloader").style.display = 'none';
        document.getElementById("tablehide").style.display = 'block';
    }
    var v = document.getElementById("POApprovalsnew");
    v.className += "tabcolor";
</script>