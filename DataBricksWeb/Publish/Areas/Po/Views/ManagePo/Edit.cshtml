@model DataBricksWeb.Areas.Po.Data.PoModel
@{
    ViewBag.Title = "Edit";
}

<style>
    #tblModule {
        font-family: Arial, Helvetica, sans-serif;
        border-collapse: collapse;
        width: 100%;
    }

        #tblModule td, #customers th {
            border: 1px solid #ddd;
            padding: 8px;
        }

        #tblModule tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        #tblModule tr:hover {
            background-color: #ddd;
        }

        #tblModule th {
            padding-top: 12px;
            padding-bottom: 12px;
            text-align: left;
            background-color: #3c8dbc;
            color: white;
        }

    #tblLicensing {
        font-family: Arial, Helvetica, sans-serif;
        border-collapse: collapse;
        width: 100%;
    }

        #tblLicensing td, #customers th {
            border: 1px solid #ddd;
            padding: 8px;
        }

        #tblLicensing tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        #tblLicensing tr:hover {
            background-color: #ddd;
        }

        #tblLicensing th {
            padding-top: 12px;
            padding-bottom: 12px;
            text-align: left;
            background-color: #3c8dbc;
            color: white;
        }
</style>



<section class="content-header">
    <h1>
        Po
    </h1>
    <ol class="breadcrumb">
        <li><a href="/dashboard/landingpage"><i class="fa fa-dashboard"></i> Home</a></li>
        <li><a href="po/list">Po List</a></li>
        <li class="active">Po</li>
    </ol>
</section>

<!-- Main content -->
<section class="content">

    <!-- SELECT2 EXAMPLE -->
    <div class="box box-default">

        <!-- /.box-header -->
        <form method="post" action="@Url.Action("Edit","ManagePo",new { area = "Po"})" enctype="multipart/form-data" id="frmPo">
            <div class="box-body">
                <div class="row">

                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Customer :</label>
                            <div>
                                <span>@Model.Po.CustomerName</span>
                            </div>

                            <input type="hidden" name="Po.CustomerId" value="@Model.Po.CustomerId" />
                            <input type="hidden" name="Po.CustomerName" value="@Model.Po.CustomerName" />
                            <input type="hidden" value="@Model.Po.Id" name="Po.Id" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Date<span style="color:red;">*</span></label>
                            <input type="text" class="form-control" id="txtPocDate" name="Po.PODate" readonly value="@(Model.Po.PODate == null ? DateTime.Now.ToString("dd-MM-yyyy") : Model.Po.PODate)" />
                        </div>
                    </div>

                    <div class="col-md-6" style="display:none">
                        <div class="form-group">
                            <label>POC Id :</label>
                            <div>
                                <span>@Model.Po.PocId</span>
                            </div>

                            <input type="hidden" name="Po.PocId" value="@Model.Po.PocId" />
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Partner :</label>
                            <div>
                                <span>@Model.Po.PartnerName</span>
                            </div>

                            <input type="hidden" name="Po.PartnerId" value="@Model.Po.PartnerId" />
                            <input type="hidden" name="Po.PartnerName" value="@Model.Po.PartnerName" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Product Name<span style="color:red;">*</span></label>
                            <select class="form-control" id="slProduct" name="Po.ProductId">
                                <option value="0">--Select--</option>
                                @if (DataCache.Products != null && DataCache.Products.Count > 0)
                                {
                                    foreach (var product in DataCache.Products)
                                    {
                                        if (product.Id == Model.Po.ProductId)
                                        {
                                            <option value="@product.Id" selected>@product.ProductName</option>
                                        }
                                        else
                                        {
                                            <option value="@product.Id">@product.ProductName</option>
                                        }
                                    }
                                }
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Qualified Domain Name<span style="color:red;">*</span></label>
                            <input type="text" class="form-control" id="txtQualifiedDomainName" name="Po.QualifiedDomainName" value="@Model.Po.QualifiedDomainName" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Public IP<span style="color:red;">*</span></label>
                            <input type="text" class="form-control" id="txtPublicIp" name="Po.PublicIp" value="@Model.Po.PublicIp" />
                        </div>
                    </div>


                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Description</label>
                            <textarea class="form-control" rows="3" name="Po.PODescription" id="txtDescription">@Model.Po.PODescription</textarea>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Upload POs</label>
                            <input type="file" id="flPO" multiple accept=".pdf" name="Po.PoFiles" />
                        </div>
                    </div>
                    <div class="col-md-6">
                    </div>

                </div>

                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <h4 style="color:black;font-weight: bold;">Technical Contact Person 1</h4>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Name<span style="color:red;">*</span></label>
                            <input type="text" class="form-control" id="txtContactName1" name="Po.TechContPersonNameOne" value="@Model.Po.TechContPersonNameOne" maxlength="256" />
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Email<span style="color:red;">*</span></label>
                            <input type="text" class="form-control" id="txtContactEmail1" name="Po.TechContPersonEmailOne" value="@Model.Po.TechContPersonEmailOne" maxlength="256" />
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Phone<span style="color:red;">*</span></label>
                            <input type="number" class="form-control" id="txtContactPhone1" name="Po.TechContPersonPhoneOne" value="@Model.Po.TechContPersonPhoneOne" maxlength="10" />
                        </div>
                    </div>
                </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <h4 style="color:black;font-weight: bold;">Technical Contact Person 2</h4>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Name</label>
                                <input type="text" class="form-control" id="txtContactName2" name="Po.TechContPersonNameTwo" value="@Model.Po.TechContPersonNameTwo" maxlength="256" />
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Email</label>
                                <input type="text" class="form-control" id="txtContactEmail2" name="Po.TechContPersonEmailTwo" value="@Model.Po.TechContPersonEmailTwo" maxlength="256" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Phone</label>
                                <input type="number" class="form-control" id="txtContactPhone2" name="Po.TechContPersonPhoneTwo" value="@Model.Po.TechContPersonPhoneTwo" maxlength="10" />
                            </div>
                        </div>
                    </div>

                    <br />
                    <div class="row">
                        <div class="col-md-12">

                            <table class="table table-bordered table-responsive" id="tblModule">
                                <thead>
                                    <tr>
                                        <th>Module</th>
                                        <th>Count</th>
                                        <th>Amount</th>
                                        <th>Total</th>
                                        <th>From Date</th>
                                        <th>To Date</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>

                                    @if (Model.PoModules != null && Model.PoModules.Count > 0)
                                    {
                                        int i = 0;
                                        foreach (var module in Model.PoModules)
                                        {
                                            <tr>
                                                <td>
                                                    <select class="slModule form-control validate" data-errmsg="please select module name" id="slModule_@i" name="PoModules[@i].ModuleId">
                                                        <option value="0">--Select--</option>
                                                        @if (DataCache.Modules.Where(x => x.ProductId == Model.Po.ProductId) != null && DataCache.Modules.Where(x => x.ProductId == Model.Po.ProductId).Count() > 0)
                                                        {
                                                            foreach (var item in DataCache.Modules.Where(x => x.ProductId == Model.Po.ProductId).ToList())
                                                            {
                                                                if (item.Id == module.ModuleId)
                                                                {
                                                                    <option value="@item.Id" selected>@item.ModuleName</option>
                                                                }
                                                                else
                                                                {
                                                                    <option value="@item.Id">@item.ModuleName</option>
                                                                }
                                                            }
                                                        }
                                                    </select>
                                                </td>
                                                <td>
                                                    <input type="number" class="form-control validate txtLineModuleCount" value="@module.ModuleCount" data-errmsg="please enter module count" name="PoModules[@i].ModuleCount" />
                                                    <input type="hidden" class="hdnIsActive" value="true" name="PoModules[@i].IsActive" />
                                                    <input type="hidden" name="PoModules[@i].Id" value="@module.Id" />
                                                </td>
                                                <td>
                                                    <input type="number" class="form-control validate txtLineModuleAmount" data-errmsg="please enter module amount" name="PoModules[@i].ModuleAmount" value="@module.ModuleAmount" />
                                                </td>
                                                <td>
                                                    <input type="number" class="form-control validate txtLineFinalModuleCount" data-errmsg="please enter total amount" readonly name="" value="@(module.ModuleCount * Convert.ToInt32(module.ModuleAmount))" />
                                                </td>
                                                <td>
                                                    <input type="text" class="form-control txtFromDate" data-errmsg="please enter module from date" name="PoModules[@i].FromDate" value="@module.FromDate.ToAppFormat()" />
                                                </td>
                                                <td>
                                                    <input type="text" class="form-control txtToDate" data-errmsg="please enter module to date" name="PoModules[@i].ToDate" value="@module.ToDate.ToAppFormat()" />
                                                </td>
                                                <td style="text-align:center">
                                                    <label class="label btnDeleteModule" style="color:red;">X</label>
                                                </td>
                                            </tr>
                                            i++;
                                        }
                                    }
                                    else
                                    {
                                        @*<tr>
                                    <td>
                                        <select class="slModule form-control" id="slModule_0" name="Model[0].ModuleId">
                                            <option value="0">--Select--</option>
                                        </select>
                                    </td>
                                    <td>
                                        <input type="number" class="form-control" name="Model[0].ModuleCount" />
                                        <input type="hidden" class="hdnIsActive" value="true" name="Model[0].IsActive" />
                                    </td>
                                    <td style="text-align:center">
                                        <label class="label btnDeleteModule" style="color:red;">X</label>
                                    </td>
                                </tr>*@
                                    }

                                </tbody>
                            </table>
                            <input type="button" value="+ Add Module" id="btnAddModule" />
                        </div>
                    </div>
                </div>



                <div class="box-footer">
                    <div class="col-lg-12 p-t-20 text-center">
                        <input type="button" style="background-color:green;border-color: green;" class="btn btn-primary" id="btnSave" value="Submit" />
                        <button type="button" onclick="pageloade();" style="background-color: #dc3545; border-color: #dc3545;margin-left: 10px;" class="btn btn-primary float-center">Cancel</button>
                    </div>
                </div>
</form>
    </div>


</section>











<script src="~/Scripts/jquery-3.4.1.min.js"></script>
<script src="~/Scripts/CustomScript.js"></script>
<script src="~/Scripts/bootstrap.js"></script>
<link href="~/Content/jquery-ui.min.css" rel="stylesheet" />
<script src="~/Scripts/Jquery.ui.min.js"></script>
<script>

    function pageloade() {
        window.location = "/po/list";
    }

    $(document).on("focusin", ".txtFromDate,.txtToDate", function () {
        $(this).datepicker({ autoclose: true, dateFormat: "dd-mm-yy" });
    });

    //fnSelectModule("slModule_0", null);

    function fnSelectModule(ddlid,moduleid) {
        $.getJSON("@Url.Action("GetModulesbasedonProduct", "ManageCommon",new { area = "Common"})?productid=" + $("#slProduct").val(), function (data) {
            var option = '<option value="0">--Select--</option>';
            $.each(data, function (index, item) {
                if (moduleid != null && moduleid > 0 && item.Id == moduleid) {
                    option += '<option value="' + item.Id + '" selected>' + item.ModuleName + '</option>';
                }
                else {
                    option += '<option value="' + item.Id + '">' + item.ModuleName + '</option>';
                }
            });
            $("#" + ddlid).html(option);
        });
    };

    $("#txtFromDate,#txtToDate").change(function () {
        fnCalculateNoofDays();
    });

    function fnCalculateNoofDays() {
        var fromdate = $("#txtFromDate").val();
        var todate = $("#txtToDate").val();

        var noofdays = fnDatediff(parseDate(fromdate), parseDate(todate));
        $("#txtTotalDays").val(noofdays);
    };

    function parseDate(str) {
        var mdy = str.split('-');
        return new Date(mdy[2], mdy[1], mdy[0]-1);
    };

    function fnDatediff(fromdt, todt) {
        return Math.round((todt - fromdt) / (1000 * 60 * 60 * 24));
    };

    $(document).on("change", ".txtLineModuleAmount", function () {
        var moduleamount = $(this).val();
        var modulecount = $(this).closest("tr").find(".txtLineModuleCount").val();
        var finalamount = fnCalculateTotalModuleAmount(moduleamount, modulecount);
        $(this).closest("tr").find(".txtLineFinalModuleCount").val(finalamount);
    });

    $(document).on("change", ".txtLineModuleCount", function () {
        var modulecount = $(this).val();
        var moduleamount = $(this).closest("tr").find(".txtLineModuleAmount").val();
        var finalamount = fnCalculateTotalModuleAmount(moduleamount, modulecount);
        $(this).closest("tr").find(".txtLineFinalModuleCount").val(finalamount);
    });


    function fnCalculateTotalModuleAmount(modulecount, moduleamount) {
        return parseInt(modulecount * moduleamount);
    };

    $("#btnAddModule").click(function () {
        fnAddModule();
    });

    function fnAddModule() {
        var trlength = $("#tblModule tbody tr").length;
        $("#tblModule").append('<tr>'+
            '<td>' +
            '<select class="slModule validate form-control" id="slModule_' + trlength + '" data-errmsg="please select module name"  name="PoModules[' + trlength+'].ModuleId">' +
            '    <option value="0">--Select--</option>' +
            '</select>' +
            '        </td>' +
            '<td>' +
            '    <input type="number" class="form-control txtLineModuleCount validate" data-errmsg="please enter module count"  name="PoModules[' + trlength +'].ModuleCount" />' +
            '<input type="hidden" class="hdnIsActive" value="true" name="PoModules[' + trlength +'].IsActive" />'+
            '</td>' +
            '<td>' +
            '           <input type="number" class="form-control txtLineModuleAmount validate" data-errmsg="please enter module amount"  name="PoModules[' + trlength  + '].ModuleAmount" value="" />' +
            '        </td>' +
            '        <td>' +
            '            <input type="number" class="form-control txtLineFinalModuleCount validate" data-errmsg="please enter total amount" readonly name="" value="" />' +
            '        </td>' +
            '<td><input type="text" class="form-control txtFromDate" data-errmsg="please enter module from date" name="PoModules[' + trlength + '].FromDate" /></td>' +
            '<td><input type="text" class="form-control txtToDate" data-errmsg="please enter module to date" name="PoModules[' + trlength + '].ToDate" /></td>' +
            '<td style="text-align:center">' +
            '    <label class="label btnDeleteModule" style="color:red;">X</label>' +
            '</td>'+
            '    </tr>');
        fnSelectModule("slModule_" + trlength, null);
    };

    $(document).on("click", ".btnDeleteModule", function () {
        $(this).closest("tr").find(".hdnIsActive").val(false);
        $(this).closest("tr").hide();
    });

    $("#btnSave").click(function () {

        var date = $("#txtPocDate").val();
        var product = $("#slProduct").val();
        var qualifieddomainname = $("#txtQualifiedDomainName").val();
        var publicip = $("#txtPublicIp").val();
        var description = $("#txtPODescription").val();
        var files = $("#flPO").val();
        var techcontname = $("#txtContactName1").val();
        var techcontemail = $("#txtContactEmail1").val();
        var techcontphone = $("#txtContactPhone1").val();




        if (fnIsNullorEmpty(date)) {
            Warning("Please enter date");
            return false;
        }


        if (product == "0") {
            Warning("Please select product");
            return false;
        }

       

        if (fnIsNullorEmpty(qualifieddomainname)) {
            Warning("Please enter qualified domain name");
            return false;
        }

        if (fnIsNullorEmpty(publicip)) {
            Warning("Please enter public ip");
            return false;
        }

        

        if (fnIsNullorEmpty(files)) {
            Warning("Please upload pos");
            return false;
        }

        if (fnIsNullorEmpty(techcontname)) {
            Warning("Please enter technical contact person name");
            return false;
        }

        if (fnIsNullorEmpty(techcontemail)) {
            Warning("Please enter technical contact person email");
            return false;
        }

        if (fnIsNullorEmpty(techcontphone)) {
            Warning("Please enter technical contact person phone number");
            return false;
        }

        if (fnIsNullorEmpty(description)) {
            //Warning("Please enter description");
            //return false;
        }


        var isvalid = true; var errmsg;
        debugger;
        $(".validate").each(function () {
            debugger;
            if ($(this).closest("tr").find(".hdnIsActive").val() == "true") {
                if ($(this).val() == 0 || $(this).val() == "") {
                    errmsg = $(this).attr("data-errmsg");
                    isvalid = false;
                    return false;
                }
            }
        });
        if (isvalid == false) {
            Warning(errmsg);
            return false;
        }

        Confirmation("Are you sure, you want to submit?");
        $("#btnConfirm").unbind().click(function () {
            $("#frmPo").submit();
        });
    });
</script>

